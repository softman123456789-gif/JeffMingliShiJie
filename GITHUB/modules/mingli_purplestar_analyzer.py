#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ç´«å¾®è«–å‘½åˆ†ææ¨¡çµ„
åŸºæ–¼ GitHub é …ç›® https://github.com/Tsai1030/Full-multi-agent
æä¾›ç´«å¾®æ–—æ•¸å‘½ç†åˆ†æåŠŸèƒ½
"""

from datetime import datetime, timedelta
from typing import Dict, List, Tuple, Optional
import random


class PurpleStarAnalyzer:
    """ç´«å¾®è«–å‘½åˆ†æå™¨ - åŸºæ–¼ç´«å¾®æ–—æ•¸ç³»çµ±"""

    # åå››ä¸»æ˜Ÿ
    MAIN_STARS = {
        'ç´«å¾®': 'å¸ç‹æ˜Ÿï¼Œå¤©è³¦é ˜å°åŠ›ã€æ°£åº¦ä¸å‡¡ã€ç‚ºäººå‰›æ­£',
        'å¤©æ©Ÿ': 'æ™ºæ…§æ˜Ÿï¼Œè°æ…§éˆå‹•ã€å¿ƒæ€è°æ˜ã€åæ‡‰æ•æ·',
        'å¤©æ¢': 'ç¦å¾·æ˜Ÿï¼Œç©©é‡å¤§æ°£ã€ç¦å£½é›™å…¨ã€åŒ–è§£å›°é›£',
        'å¤©åŒ': 'ç¦æ˜Ÿï¼Œæ¨‚è§€é–‹æœ—ã€ç¦æ°£åè¶³ã€æ¸©å’Œè¦ªåˆ‡',
        'æ­¦æ›²': 'è²¡æ˜Ÿï¼Œæ±ºæ–·åŠ›å¼·ã€è²¡é‹äº¨é€šã€åŸ·è¡ŒåŠ›å¼·',
        'å¤©åºœ': 'åº«æ˜Ÿï¼Œç†è²¡èƒ½åŠ›å¼·ã€ç‚ºäººåšé“ã€é ˜å°åŠ›ä½³',
        'å»‰è²': 'æ¬¡æ¡ƒèŠ±ï¼Œç†±æƒ…ä¸»å‹•ã€æœ‰è‰²å½©ã€è®Šå‹•æ€§å¼·',
        'è²ªç‹¼': 'æ¡ƒèŠ±æ˜Ÿï¼Œå¥½è‰²ã€è²ªå¿ƒã€è®ŠåŒ–å¤šç«¯ã€å‰µæ„åè¶³',
        'å·¨é–€': 'æš—æ˜Ÿï¼Œå¤šè¨€å¤šèªã€åè€Œå¤±æ„ã€ä½†æœ‰æ·±åº¦',
        'å¤©ç›¸': 'è¼”æ˜Ÿï¼Œå¿ƒå–„ã€ç‚ºäººè€å¯¦ã€èƒ½æˆå¤§äº‹',
        'ç ´è»': 'è€—æ˜Ÿï¼Œè¡å‹•æ€¥èºã€ç ´å£æ¬²å¼·ã€ä½†æœ‰è¡å‹',
        'ä¸ƒæ®º': 'å°‡æ˜Ÿï¼ŒåŸ·è¡ŒåŠ›å¼·ã€çµ±é ˜èƒ½åŠ›å¥½ã€è¡å‹•æ˜“å¤±æ§',
    }

    # åäºŒå®®ä½
    PALACES = [
        'å‘½å®®', 'å…„å¼Ÿå®®', 'å¤«å¦»å®®', 'å­å¥³å®®', 'è²¡å¸›å®®', 'ç–¾å„å®®',
        'é·ç§»å®®', 'å¥´åƒ•å®®', 'å®˜ç¥¿å®®', 'ç”°å®…å®®', 'ç¦å¾·å®®', 'çˆ¶æ¯å®®'
    ]

    # ç”Ÿè‚–å°æ‡‰
    ZODIACS = ['é¼ ', 'ç‰›', 'è™', 'å…”', 'é¾', 'è›‡', 'é¦¬', 'ç¾Š', 'çŒ´', 'é›', 'ç‹—', 'è±¬']

    # å¤©å¹²åœ°æ”¯
    STEMS = ['ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸']
    BRANCHES = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥']

    # ç´«å¾®æ˜Ÿç›¤æ’åˆ— (ç°¡åŒ–ç‰ˆ)
    STAR_DISTRIBUTION = {
        'å­': ['ç´«å¾®', 'å¤©ç›¸'],
        'ä¸‘': ['å¤©æ©Ÿ', 'å¤©æ¢'],
        'å¯…': ['å¤©åŒ', 'å»‰è²'],
        'å¯': ['æ­¦æ›²', 'å¤©åºœ'],
        'è¾°': ['å¤©æ©Ÿ', 'è²ªç‹¼'],
        'å·³': ['å»‰è²', 'ç ´è»'],
        'åˆ': ['ç´«å¾®', 'å¤©åºœ'],
        'æœª': ['å¤©æ©Ÿ', 'ä¸ƒæ®º'],
        'ç”³': ['æ­¦æ›²', 'å»‰è²'],
        'é…‰': ['å¤©åºœ', 'å¤©ç›¸'],
        'æˆŒ': ['è²ªç‹¼', 'å¤©åŒ'],
        'äº¥': ['ç´«å¾®', 'ç ´è»']
    }

    # å››åŒ–æ˜Ÿ (ç°¡åŒ–ç‰ˆ)
    TRANSFORMATIONS = {
        'ç”²': ['å»‰è²åŒ–ç¥¿', 'ç ´è»åŒ–æ¬Š', 'æ­¦æ›²åŒ–ç§‘', 'å¤ªé™°åŒ–å¿Œ'],
        'ä¹™': ['å¤©æ©ŸåŒ–ç¥¿', 'å¤©æ¢åŒ–æ¬Š', 'ç´«å¾®åŒ–ç§‘', 'å¤©åŒåŒ–å¿Œ'],
        'ä¸™': ['å¤©åŒåŒ–ç¥¿', 'å¤©æ©ŸåŒ–æ¬Š', 'å¤©æ¢åŒ–ç§‘', 'ç´«å¾®åŒ–å¿Œ'],
        'ä¸': ['å¤ªé™°åŒ–ç¥¿', 'è²ªç‹¼åŒ–æ¬Š', 'å¤©æ©ŸåŒ–ç§‘', 'å·¨é–€åŒ–å¿Œ'],
        'æˆŠ': ['è²ªç‹¼åŒ–ç¥¿', 'å¤ªé™°åŒ–æ¬Š', 'å¤©åŒåŒ–ç§‘', 'å¤©æ©ŸåŒ–å¿Œ'],
        'å·±': ['æ­¦æ›²åŒ–ç¥¿', 'å»‰è²åŒ–æ¬Š', 'å¤©åºœåŒ–ç§‘', 'å¤©ç›¸åŒ–å¿Œ'],
        'åºš': ['å¤ªé™°åŒ–ç¥¿', 'æ­¦æ›²åŒ–æ¬Š', 'å¤©åºœåŒ–ç§‘', 'å¤©åŒåŒ–å¿Œ'],
        'è¾›': ['å·¨é–€åŒ–ç¥¿', 'å¤ªé™°åŒ–æ¬Š', 'è²ªç‹¼åŒ–ç§‘', 'å¤©æ¢åŒ–å¿Œ'],
        'å£¬': ['å¤©æ¢åŒ–ç¥¿', 'ç´«å¾®åŒ–æ¬Š', 'å·¦è¼”åŒ–ç§‘', 'æ­¦æ›²åŒ–å¿Œ'],
        'ç™¸': ['å¤©åºœåŒ–ç¥¿', 'æ­¦æ›²åŒ–æ¬Š', 'ç´«å¾®åŒ–ç§‘', 'å¤©æ©ŸåŒ–å¿Œ']
    }

    def __init__(self):
        """åˆå§‹åŒ–ç´«å¾®è«–å‘½åˆ†æå™¨"""
        pass

    def analyze_ziwei(self, year: int, month: int, day: int, 
                     hour: int = 12, gender: str = 'M') -> Dict:
        """
        åˆ†æç´«å¾®æ–—æ•¸å‘½ç›¤
        
        Args:
            year: å‡ºç”Ÿå¹´
            month: å‡ºç”Ÿæœˆ (1-12)
            day: å‡ºç”Ÿæ—¥ (1-31)
            hour: å‡ºç”Ÿæ™‚è¾° (0-23)
            gender: æ€§åˆ¥ ('M' ç”·, 'F' å¥³)
            
        Returns:
            ç´«å¾®å‘½ç›¤åˆ†æçµæœ
        """
        if not (1 <= month <= 12 and 1 <= day <= 31 and 0 <= hour <= 23):
            return {
                'success': False,
                'error': 'æ—¥æœŸæˆ–æ™‚é–“è¼¸å…¥ç¯„åœä¸æ­£ç¢º',
                'message': 'è«‹æª¢æŸ¥æœˆä»½(1-12)ã€æ—¥æœŸ(1-31)ã€æ™‚è¾°(0-23)'
            }
        
        try:
            # 1. è¨ˆç®—å‘½å®®
            year_index = (year - 1900) % 12
            month_index = (month - 1) % 12
            day_index = (day - 1) % 12
            hour_index = (hour // 2) % 12
            
            # ç°¡åŒ–ç‰ˆï¼šæ ¹æ“šæ—¥æœŸè¨ˆç®—å‘½å®®ä½ç½®
            ming_gong_index = (month_index + hour_index) % 12
            ming_gong_palace = self.PALACES[ming_gong_index]
            ming_gong_branch = self.BRANCHES[ming_gong_index]
            
            # 2. æ’åˆ—åå››ä¸»æ˜Ÿ
            main_stars = self._arrange_main_stars(ming_gong_index, gender)
            
            # 3. è¨ˆç®—å››åŒ–æ˜Ÿ
            year_stem_index = (year - 1900) % 10
            year_stem = self.STEMS[year_stem_index]
            transformations = self._get_transformations(year_stem)
            
            # 4. è¨ˆç®—ç´éŸ³äº”è¡Œå’Œç”Ÿè‚–
            zodiac = self.ZODIACS[year_index]
            nayin = self._calculate_nayin(year)
            
            # 5. ç”Ÿæˆå‘½ç›¤åˆ†æ
            palace_analysis = self._analyze_palaces(main_stars, ming_gong_index)
            
            # 6. ç”Ÿæˆæ€§æ ¼åˆ†æ
            personality = self._analyze_personality(main_stars, gender)
            
            # 7. ç”Ÿæˆè²¡é‹ã€äº‹æ¥­ã€æ„›æƒ…åˆ†æ
            fortune = self._analyze_fortune(main_stars, transformations)
            career = self._analyze_career(main_stars, ming_gong_index)
            love = self._analyze_love(main_stars, gender)
            
            result = {
                'success': True,
                'date': f"{year}å¹´{month:02d}æœˆ{day:02d}æ—¥ {hour:02d}æ™‚",
                'gender': 'ç”·' if gender == 'M' else 'å¥³',
                'zodiac': zodiac,
                'nayin': nayin,
                'ming_gong': {
                    'palace': ming_gong_palace,
                    'branch': ming_gong_branch,
                    'index': ming_gong_index
                },
                'main_stars': main_stars,
                'transformations': transformations,
                'palace_analysis': palace_analysis,
                'personality': personality,
                'fortune': fortune,
                'career': career,
                'love': love,
                'overall': self._generate_overall_analysis(main_stars, personality, fortune)
            }
            
            return result
            
        except Exception as e:
            return {
                'success': False,
                'error': str(e),
                'message': 'ç´«å¾®è«–å‘½å¤±æ•—ï¼Œè«‹æª¢æŸ¥è¼¸å…¥çš„æ—¥æœŸå’Œæ™‚é–“æ˜¯å¦æ­£ç¢º'
            }

    def _arrange_main_stars(self, ming_gong_index: int, gender: str = 'M') -> Dict:
        """æ’åˆ—åå››ä¸»æ˜Ÿ"""
        stars = {}
        branch = self.BRANCHES[ming_gong_index]
        
        # æ ¹æ“šå‘½å®®åœ°æ”¯ç²å–ä¸»æ˜Ÿ
        palace_stars = self.STAR_DISTRIBUTION.get(branch, ['ç´«å¾®', 'å¤©åºœ'])
        
        # åˆ†é…åˆ°å®®ä½
        for i, palace in enumerate(self.PALACES):
            star_index = (i + ming_gong_index) % len(palace_stars)
            main_star = palace_stars[star_index]
            
            # ç²å–ä¸»æ˜Ÿæè¿°
            description = self.MAIN_STARS.get(main_star, 'ç„¡èª¬æ˜')
            
            stars[palace] = {
                'star': main_star,
                'description': description
            }
        
        return stars

    def _get_transformations(self, year_stem: str) -> Dict:
        """ç²å–å››åŒ–æ˜Ÿ"""
        return {
            'stem': year_stem,
            'transformations': self.TRANSFORMATIONS.get(year_stem, ['æœªçŸ¥åŒ–ç¥¿'] * 4)
        }

    def _calculate_nayin(self, year: int) -> str:
        """è¨ˆç®—ç´éŸ³äº”è¡Œ (å…­åç”²å­ç´éŸ³)"""
        nayin_map = {
            0: 'é‡‘', 1: 'é‡‘', 2: 'æœ¨', 3: 'æœ¨', 4: 'æ°´',
            5: 'æ°´', 6: 'ç«', 7: 'ç«', 8: 'åœŸ', 9: 'åœŸ'
        }
        year_index = (year - 1900) % 60
        stem_index = year_index % 10
        return nayin_map[stem_index % 10]

    def _analyze_palaces(self, main_stars: Dict, ming_gong_index: int) -> str:
        """åˆ†æå„å®«ä½ - æ˜¾ç¤ºæ‰€æœ‰12ä¸ªå®«ä½çš„ä¸»æ˜Ÿ"""
        analysis = "ã€åäºŒå®®ä½ä¸»æ˜Ÿé…ç½®ã€‘\n"
        analysis += "="*60 + "\n\n"
        
        # æ˜¾ç¤ºæ‰€æœ‰12ä¸ªå®«ä½åŠå…¶ä¸»æ˜Ÿ
        for i, (palace, star_info) in enumerate(main_stars.items(), 1):
            star_name = star_info['star']
            star_desc = star_info['description']
            
            analysis += f"â”Œ{'â”€'*58}â”\n"
            analysis += f"â”‚ {palace:8s} - ä¸»æ˜Ÿï¼š{star_name:6s}{' '*(42-len(palace)-len(star_name))}â”‚\n"
            analysis += f"â”œ{'â”€'*58}â”¤\n"
            analysis += f"â”‚ ç‰¹è³ªï¼š{star_desc:46s}â”‚\n"
            
            # æ ¹æ®å®«ä½æ·»åŠ å…·ä½“è¯´æ˜
            palace_meanings = {
                'å‘½å®®': 'ä¸»ç®¡ä¸€ç”Ÿå‘½è¿ã€æ€§æ ¼æ°”è´¨ã€å¤–åœ¨å½¢è±¡',
                'å…„å¼Ÿå®®': 'ä¸»ç®¡æ‰‹è¶³å…³ç³»ã€æœ‹å‹ç›¸å¤„ã€åˆä½œä¼™ä¼´',
                'å¤«å¦»å®®': 'ä¸»ç®¡å©šå§»æ„Ÿæƒ…ã€é…å¶ç‰¹è´¨ã€æ„Ÿæƒ…çŠ¶æ€',
                'å­å¥³å®®': 'ä¸»ç®¡å­å¥³ç¼˜åˆ†ã€åˆ›é€ åŠ›ã€ç”Ÿè‚²èƒ½åŠ›',
                'è²¡å¸›å®®': 'ä¸»ç®¡è´¢è¿çŠ¶å†µã€ç†è´¢èƒ½åŠ›ã€è´¢å¯Œç´¯ç§¯',
                'ç–¾å„å®®': 'ä¸»ç®¡å¥åº·ä½“è´¨ã€ç–¾ç—…å€¾å‘ã€æ„å¤–ç¾å®³',
                'é·ç§»å®®': 'ä¸»ç®¡å¤–å‡ºè¿åŠ¿ã€äººé™…å…³ç³»ã€è´µäººåŠ©åŠ›',
                'å¥´åƒ•å®®': 'ä¸»ç®¡ä¸‹å±å…³ç³»ã€æœ‹å‹è´¨é‡ã€äº¤å‹çŠ¶å†µ',
                'å®˜ç¥¿å®®': 'ä¸»ç®¡äº‹ä¸šå‘å±•ã€å·¥ä½œè¡¨ç°ã€ç¤¾ä¼šåœ°ä½',
                'ç”°å®…å®®': 'ä¸»ç®¡ä¸åŠ¨äº§ã€å®¶åº­ç¯å¢ƒã€ç½®äº§èƒ½åŠ›',
                'ç¦å¾·å®®': 'ä¸»ç®¡ç²¾ç¥ç”Ÿæ´»ã€å…´è¶£çˆ±å¥½ã€äº«å—èƒ½åŠ›',
                'çˆ¶æ¯å®®': 'ä¸»ç®¡çˆ¶æ¯ç¼˜åˆ†ã€é•¿è¾ˆå…³ç³»ã€å®¶åº­èƒŒæ™¯'
            }
            
            if palace in palace_meanings:
                analysis += f"â”‚ æ„ä¹‰ï¼š{palace_meanings[palace]:46s}â”‚\n"
            
            # æ ¹æ®ä¸»æ˜Ÿå’Œå®«ä½ç»™å‡ºå…·ä½“åˆ†æ
            star_palace_analysis = self._get_star_palace_analysis(star_name, palace)
            if star_palace_analysis:
                analysis += f"â”‚ å½±å“ï¼š{star_palace_analysis:46s}â”‚\n"
            
            analysis += f"â””{'â”€'*58}â”˜\n\n"
        
        analysis += "="*60 + "\n"
        analysis += "ã€é‡è¦æç¤ºã€‘\n"
        analysis += "â€¢ å‘½å®®ä¸»æ˜Ÿå†³å®šåŸºæœ¬æ€§æ ¼å’Œäººç”Ÿèµ°å‘\n"
        analysis += "â€¢ å¤«å¦»å®®ä¸»æ˜Ÿå½±å“å©šå§»å’Œæ„Ÿæƒ…å“è´¨\n"
        analysis += "â€¢ è²¡å¸›å®®ä¸»æ˜Ÿæ±ºå®šè²¡é‹å’Œç†è²¡èƒ½åŠ›\n"
        analysis += "â€¢ å®˜ç¥¿å®®ä¸»æ˜Ÿå½±éŸ¿äº‹æ¥­å’Œå·¥ä½œç™¼å±•\n"
        analysis += "â€¢ å…¶ä»–å®®ä½ä¸»æ˜Ÿå½±éŸ¿äººç”Ÿå„å€‹å±¤é¢\n"
        
        return analysis
    
    def _get_star_palace_analysis(self, star: str, palace: str) -> str:
        """è·å–ä¸»æ˜Ÿåœ¨ç‰¹å®šå®«ä½çš„å½±å“åˆ†æ"""
        # ä¸»æ˜Ÿåœ¨ä¸åŒå®«ä½çš„å½±å“
        star_palace_effects = {
            ('ç´«å¾®', 'å‘½å®®'): 'å¸ç‹ä¹‹å‘½ï¼Œé ˜å°åŠ›å¼·ï¼Œæ°£åº¦ä¸å‡¡',
            ('ç´«å¾®', 'è²¡å¸›å®®'): 'è²¡é‹äº¨é€šï¼Œå–„æ–¼ç†è²¡ï¼Œå¯Œè²´æœ‰é¤˜',
            ('ç´«å¾®', 'å®˜ç¥¿å®®'): 'äº‹æ¥­æœ‰æˆï¼Œå®˜é‹äº¨é€šï¼Œä½é«˜æ¬Šé‡',
            ('ç´«å¾®', 'å¤«å¦»å®®'): 'é…å¶å„ªç§€ï¼Œå©šå§»ç¾æ»¿ï¼Œå®¶åº­å’Œè«§',
            
            ('å¤©æ©Ÿ', 'å‘½å®®'): 'è°æ˜æ©Ÿæ™ºï¼Œåæ‡‰æ•æ·ï¼Œå–„æ–¼ç­–åŠƒ',
            ('å¤©æ©Ÿ', 'è²¡å¸›å®®'): 'è²¡é‹å¤šè®Šï¼Œéˆæ´»ç†è²¡ï¼Œé©åˆæŠ•è³‡',
            ('å¤©æ©Ÿ', 'å®˜ç¥¿å®®'): 'é©åˆå‹•è…¦å·¥ä½œï¼Œç­–åŠƒèƒ½åŠ›å¼·',
            ('å¤©æ©Ÿ', 'å¤«å¦»å®®'): 'å¤«å¦»æºé€šè‰¯å¥½ï¼Œæ€æƒ³å¥‘åˆ',
            
            ('å¤©åºœ', 'å‘½å®®'): 'ç©©é‡åšé“ï¼Œé ˜å°åŠ›å¼·ï¼Œå—äººä¿¡è³´',
            ('å¤©åºœ', 'è²¡å¸›å®®'): 'è²¡åº«è±ç›ˆï¼Œç†è²¡æœ‰é“ï¼Œè²¡é‹ç©©å¥',
            ('å¤©åºœ', 'å®˜ç¥¿å®®'): 'ç®¡ç†èƒ½åŠ›å¼·ï¼Œäº‹æ¥­ç©©å®šç™¼å±•',
            ('å¤©åºœ', 'ç”°å®…å®®'): 'ç½®ç”¢èƒ½åŠ›å¼·ï¼Œå®¶æ¥­èˆˆæ—º',
            
            ('æ­¦æ›²', 'å‘½å®®'): 'å‰›æ¯…æœæ±ºï¼ŒåŸ·è¡ŒåŠ›å¼·ï¼Œæ„å¿—å …å®š',
            ('æ­¦æ›²', 'è²¡å¸›å®®'): 'è²¡æ˜Ÿå…¥è²¡å®®ï¼Œè²¡é‹æ¥µä½³ï¼Œå–„æ–¼è³ºéŒ¢',
            ('æ­¦æ›²', 'å®˜ç¥¿å®®'): 'äº‹æ¥­å¿ƒå¼·ï¼ŒåŸ·è¡ŒåŠ›ä½³ï¼Œæˆå°±å¯æœŸ',
            
            ('å¤©åŒ', 'å‘½å®®'): 'æ¨‚è§€é–‹æœ—ï¼Œç¦æ°£æ·±åšï¼Œäººç·£æ¥µä½³',
            ('å¤©åŒ', 'ç¦å¾·å®®'): 'ç²¾ç¥å¯Œè¶³ï¼ŒçŸ¥è¶³å¸¸æ¨‚ï¼Œäº«ç¦ä¹‹å‘½',
            ('å¤©åŒ', 'å¤«å¦»å®®'): 'æ„Ÿæƒ…å’Œè«§ï¼Œå¤«å¦»æ©æ„›ï¼Œå®¶åº­å¹¸ç¦',
            
            ('å»‰è²', 'å‘½å®®'): 'ç†±æƒ…ä¸»å‹•ï¼Œå¯Œæœ‰é­…åŠ›ï¼Œè®ŠåŒ–å¤šç«¯',
            ('å»‰è²', 'å®˜ç¥¿å®®'): 'é©åˆå‰µæ„å·¥ä½œï¼Œè®ŠåŒ–æ€§å¼·',
            ('å»‰è²', 'å¤«å¦»å®®'): 'æ„Ÿæƒ…è±å¯Œï¼Œä½†éœ€æ³¨æ„æ³¢æŠ˜',
            
            ('å¤©ç›¸', 'å‘½å®®'): 'å¿ƒåœ°å–„è‰¯ï¼Œç‚ºäººè€å¯¦ï¼Œèƒ½æˆå¤§äº‹',
            ('å¤©ç›¸', 'å¤«å¦»å®®'): 'é…å¶è³¢è‰¯ï¼Œå©šå§»ç©©å®š',
            ('å¤©ç›¸', 'å®˜ç¥¿å®®'): 'é©åˆè¼”åŠ©å·¥ä½œï¼Œè²´äººé‹å¼·',
            
            ('è²ªç‹¼', 'å‘½å®®'): 'å¤šæ‰å¤šè—ï¼Œå‰µæ„åè¶³ï¼Œç¤¾äº¤èƒ½åŠ›å¼·',
            ('è²ªç‹¼', 'è²¡å¸›å®®'): 'è²¡é‹å¤šè®Šï¼Œåè²¡é‹ä½³',
            ('è²ªç‹¼', 'å¤«å¦»å®®'): 'æ¡ƒèŠ±é‹æ—ºï¼Œä½†éœ€è¬¹æ…æ„Ÿæƒ…',
            
            ('å·¨é–€', 'å‘½å®®'): 'å£æ‰æ¥µä½³ï¼Œæ€æ…®æ·±é ï¼Œä½†æ˜“å¤šç–‘',
            ('å·¨é–€', 'å®˜ç¥¿å®®'): 'é©åˆæ•™è‚²ã€è«®è©¢ã€æºé€šé¡å·¥ä½œ',
            ('å·¨é–€', 'å¤«å¦»å®®'): 'éœ€æ³¨æ„æºé€šï¼Œé¿å…å£èˆŒæ˜¯é',
            
            ('ç ´è»', 'å‘½å®®'): 'é–‹å‰µåŠ›å¼·ï¼Œå‹‡æ–¼æ”¹é©ï¼Œè¡å‹åè¶³',
            ('ç ´è»', 'å®˜ç¥¿å®®'): 'é©åˆé–‹å‰µæ–°äº‹æ¥­ï¼Œè®Šé©èƒ½åŠ›å¼·',
            ('ç ´è»', 'å¤«å¦»å®®'): 'æ„Ÿæƒ…è®ŠåŒ–å¤§ï¼Œéœ€è¦åŒ…å®¹',
            
            ('ä¸ƒæ®º', 'å‘½å®®'): 'ç¨ç«‹æ€§å¼·ï¼ŒåŸ·è¡ŒåŠ›ä½³ï¼Œé ˜å°æ‰èƒ½',
            ('ä¸ƒæ®º', 'å®˜ç¥¿å®®'): 'äº‹æ¥­è¡å‹è¶³ï¼Œé©åˆç«¶çˆ­è¡Œæ¥­',
            ('ä¸ƒæ®º', 'è²¡å¸›å®®'): 'è²¡é‹æ³¢å‹•ï¼Œéœ€ç©©å¥ç†è²¡',
        }
        
        # ä¼˜å…ˆè¿”å›ç‰¹å®šç»„åˆçš„åˆ†æ
        key = (star, palace)
        if key in star_palace_effects:
            return star_palace_effects[key]
        
        # å¦‚æœæ²¡æœ‰ç‰¹å®šç»„åˆï¼Œè¿”å›é€šç”¨åˆ†æ
        general_effects = {
            'ç´«å¾®': 'å¸¶ä¾†è²´æ°£å’Œé ˜å°åŠ›ï¼Œæå‡è©²å®®ä½èƒ½é‡',
            'å¤©æ©Ÿ': 'å¸¶ä¾†æ™ºæ…§å’Œè®ŠåŒ–ï¼Œå¢å¼·éˆæ´»æ€§',
            'å¤©åºœ': 'å¸¶ä¾†ç©©å®šå’Œå¯Œè¶³ï¼Œå¢å¼·ä¿å®ˆåŠ›',
            'æ­¦æ›²': 'å¸¶ä¾†å‰›æ¯…å’Œè²¡é‹ï¼Œå¢å¼·åŸ·è¡ŒåŠ›',
            'å¤©åŒ': 'å¸¶ä¾†ç¦æ°£å’Œå’Œè«§ï¼Œå¢å¼·è¦ªå’ŒåŠ›',
            'å»‰è²': 'å¸¶ä¾†ç†±æƒ…å’Œè®ŠåŒ–ï¼Œå¢å¼·é­…åŠ›',
            'å¤©æ¢': 'å¸¶ä¾†ç©©é‡å’Œæ™ºæ…§ï¼Œå¢å¼·åŒ–è§£åŠ›',
            'å¤©ç›¸': 'å¸¶ä¾†å–„è‰¯å’Œè¼”åŠ©ï¼Œå¢å¼·å”èª¿åŠ›',
            'è²ªç‹¼': 'å¸¶ä¾†å¤šæ‰å’Œå‰µæ„ï¼Œå¢å¼·ç¤¾äº¤åŠ›',
            'å·¨é–€': 'å¸¶ä¾†å£æ‰å’Œæ€æ…®ï¼Œéœ€æ³¨æ„æºé€š',
            'ç ´è»': 'å¸¶ä¾†é–‹å‰µå’Œæ”¹é©ï¼Œå¢å¼·è®Šé©åŠ›',
            'ä¸ƒæ®º': 'å¸¶ä¾†ç¨ç«‹å’ŒåŸ·è¡Œï¼Œå¢å¼·ç«¶çˆ­åŠ›',
        }
        
        return general_effects.get(star, 'å½±éŸ¿è©²å®®ä½çš„ç™¼å±•')

    def _analyze_personality(self, main_stars: Dict, gender: str = 'M') -> str:
        """åˆ†ææ€§æ ¼"""
        analysis = "ã€æ€§æ ¼åˆ†æã€‘\n"
        
        ming_gong_star = main_stars.get('å‘½å®®', {}).get('star', 'ç´«å¾®')
        
        personality_map = {
            'ç´«å¾®': 'ä½ æ˜¯å¤©ç”Ÿçš„é ˜å°è€…ï¼Œæ°£åº¦ä¸å‡¡ï¼Œç‚ºäººå‰›æ­£ï¼Œæœ‰å¸ç‹ä¹‹æ°£ã€‚',
            'å¤©æ©Ÿ': 'ä½ è°æ…§éˆå‹•ï¼Œå¿ƒæ€è°æ˜ï¼Œåæ‡‰æ•æ·ï¼Œé©åˆå¾äº‹éœ€è¦è…¦åŠ›çš„å·¥ä½œã€‚',
            'å¤©æ¢': 'ä½ ç©©é‡å¤§æ°£ï¼Œç¦å£½é›™å…¨ï¼Œèƒ½åŒ–è§£å›°é›£ï¼Œæ˜¯å¤©ç”Ÿçš„æ™ºè€…å’Œä¿è­·è€…ã€‚',
            'å¤©åŒ': 'ä½ æ¨‚è§€é–‹æœ—ï¼Œç¦æ°£åè¶³ï¼Œæº«å’Œè¦ªåˆ‡ï¼Œå®¹æ˜“å’Œä»–äººç›¸è™•ã€‚',
            'æ­¦æ›²': 'ä½ æ±ºæ–·åŠ›å¼·ï¼Œè²¡é‹äº¨é€šï¼ŒåŸ·è¡ŒåŠ›å¼·ï¼Œé©åˆç¶“ç‡Ÿå’Œç®¡ç†ã€‚',
            'å¤©åºœ': 'ä½ ç†è²¡èƒ½åŠ›å¼·ï¼Œç‚ºäººåšé“ï¼Œé ˜å°åŠ›ä½³ï¼Œæ˜¯å¤©ç”Ÿçš„ç®¡ç†è€…ã€‚',
            'å»‰è²': 'ä½ ç†±æƒ…ä¸»å‹•ï¼Œæœ‰è‰²å½©ï¼Œè®Šå‹•æ€§å¼·ï¼Œé©åˆå‰µæ„å·¥ä½œã€‚',
            'è²ªç‹¼': 'ä½ å¥½è‰²è²ªå¿ƒï¼Œè®ŠåŒ–å¤šç«¯ï¼Œå‰µæ„åè¶³ï¼Œé©åˆéŠ·å”®å’Œå¸‚å ´å·¥ä½œã€‚',
            'å·¨é–€': 'ä½ å¤šè¨€å¤šèªï¼Œä½†æœ‰æ·±åº¦ï¼Œé©åˆæ•™è‚²å’Œè«®è©¢å·¥ä½œã€‚',
            'å¤©ç›¸': 'ä½ å¿ƒå–„ï¼Œç‚ºäººè€å¯¦ï¼Œèƒ½æˆå¤§äº‹ï¼Œæ˜¯å¤©ç”Ÿçš„è¼”åŠ©è€…ã€‚',
            'ç ´è»': 'ä½ è¡å‹•æ€¥èºï¼Œç ´å£æ¬²å¼·ï¼Œä½†æœ‰è¡å‹ï¼Œé©åˆæ”¹é©å’Œå‰µæ–°ã€‚',
            'ä¸ƒæ®º': 'ä½ åŸ·è¡ŒåŠ›å¼·ï¼Œçµ±é ˜èƒ½åŠ›å¥½ï¼Œä½†è¡å‹•æ˜“å¤±æ§ï¼Œéœ€è¦è‡ªæˆ‘ä¿®é¤Šã€‚',
        }
        
        analysis += personality_map.get(ming_gong_star, 'å€‹æ€§è¤‡é›œå¤šè®Šã€‚')
        
        return analysis

    def _analyze_fortune(self, main_stars: Dict, transformations: Dict) -> str:
        """åˆ†æè²¡é‹"""
        analysis = "ã€è²¡é‹åˆ†æã€‘\n"
        
        cai_gong_star = main_stars.get('è²¡å¸›å®®', {}).get('star', 'æ­¦æ›²')
        
        if 'æ­¦æ›²' in cai_gong_star or 'å¤©åºœ' in cai_gong_star:
            analysis += "è²¡é‹ä½³ï¼Œé©åˆå¾äº‹å•†æ¥­å’ŒæŠ•è³‡ã€‚\n"
            analysis += "å»ºè­°å¤šåšç©©å¥çš„æŠ•è³‡ï¼Œé¿å…éåº¦å†’éšªã€‚"
        elif 'è²ªç‹¼' in cai_gong_star:
            analysis += "è²¡é‹è®ŠåŒ–å¤§ï¼Œè³ºéŒ¢é€Ÿåº¦å¿«ä½†æ¶ˆè€—ä¹Ÿå¿«ã€‚\n"
            analysis += "å»ºè­°å»ºç«‹ç†è²¡è¨ˆåŠƒï¼Œé¿å…å¥¢ä¾ˆæ¶ˆè²»ã€‚"
        else:
            analysis += "è²¡é‹å¹³ç©©ï¼Œéœ€è¦ç©©å®šçš„å·¥ä½œæ”¶å…¥ã€‚\n"
            analysis += "å»ºè­°è¬¹æ…ç†è²¡ï¼Œä¸å®œéåº¦æŠ•æ©Ÿã€‚"
        
        return analysis

    def _analyze_career(self, main_stars: Dict, ming_gong_index: int) -> str:
        """åˆ†æäº‹æ¥­"""
        analysis = "ã€äº‹æ¥­åˆ†æã€‘\n"
        
        guan_gong_star = main_stars.get('å®˜ç¥¿å®®', {}).get('star', 'ç´«å¾®')
        
        career_map = {
            'ç´«å¾®': 'é©åˆå¾æ”¿ã€é ˜å°ã€é«˜ç®¡è·ä½ã€‚',
            'å¤©æ©Ÿ': 'é©åˆç ”ç©¶ã€åˆ†æã€æ•™è‚²ã€è¨­è¨ˆå·¥ä½œã€‚',
            'å¤©æ¢': 'é©åˆå…¬å‹™å“¡ã€æ•™å¸«ã€è«®è©¢å·¥ä½œã€‚',
            'å¤©åŒ': 'é©åˆè—è¡“ã€æœå‹™ã€å…¬é—œã€äººè³‡å·¥ä½œã€‚',
            'æ­¦æ›²': 'é©åˆè²¡å‹™ã€å•†æ¥­ã€ç®¡ç†å·¥ä½œã€‚',
            'å¤©åºœ': 'é©åˆä¼æ¥­ç®¡ç†ã€æŠ•è³‡ã€æˆ¿åœ°ç”¢å·¥ä½œã€‚',
            'å»‰è²': 'é©åˆéŠ·å”®ã€å¸‚å ´ã€å‰µæ„ã€è¡¨æ¼”å·¥ä½œã€‚',
            'è²ªç‹¼': 'é©åˆéŠ·å”®ã€å¤–äº¤ã€å‰µæ¥­å·¥ä½œã€‚',
            'å·¨é–€': 'é©åˆå¾‹å¸«ã€è¨˜è€…ã€æ•™è‚²ã€è«®è©¢å·¥ä½œã€‚',
            'å¤©ç›¸': 'é©åˆå…¬å‹™å“¡ã€äººè³‡ã€è¡Œæ”¿å·¥ä½œã€‚',
            'ç ´è»': 'é©åˆè»è­¦ã€æ”¹é©ã€å‰µæ–°ã€å‰µæ¥­å·¥ä½œã€‚',
            'ä¸ƒæ®º': 'é©åˆè»è­¦ã€é«”è‚²ã€ç«¶çˆ­è¡Œæ¥­å·¥ä½œã€‚',
        }
        
        analysis += career_map.get(guan_gong_star, 'é¸æ“‡é©åˆè‡ªå·±çš„å·¥ä½œæœ€é‡è¦ã€‚')
        
        return analysis

    def _analyze_love(self, main_stars: Dict, gender: str = 'M') -> str:
        """åˆ†ææ„›æƒ…"""
        analysis = "ã€æ„›æƒ…åˆ†æã€‘\n"
        
        fu_mao_star = main_stars.get('å¤«å¦»å®®', {}).get('star', 'å¤©åŒ')
        
        love_map_male = {
            'ç´«å¾®': 'å©šå§»ç©©å®šï¼Œæ“…é•·ç¶“ç‡Ÿæ„Ÿæƒ…ç”Ÿæ´»ã€‚',
            'å¤©æ©Ÿ': 'è°æ…§è°æ•ï¼Œä½†æ˜“æ–¼å¤šæƒ…ï¼Œéœ€è¦ç†æ€§é¸æ“‡ã€‚',
            'å¤©æ¢': 'å¤«å¦»æ©æ„›ï¼Œå®¶åº­å¹¸ç¦ï¼Œå©šå§»ç©©å®šã€‚',
            'å¤©åŒ': 'æ„Ÿæƒ…é †æš¢ï¼Œå®¹æ˜“å¾—åˆ°ç•°æ€§é’çã€‚',
            'æ­¦æ›²': 'å©šå§»ä»¥åˆ©ç›Šç‚ºä¸»ï¼Œéœ€è¦ç¶“æ¿ŸåŸºç¤ã€‚',
            'å¤©åºœ': 'å¤«å¦»é—œä¿‚å’Œè«§ï¼Œé©åˆæ—©å©šã€‚',
            'å»‰è²': 'æ„Ÿæƒ…è±å¯Œï¼Œä½†æ˜“æœ‰æ³¢æŠ˜å’Œè®Šå‹•ã€‚',
            'è²ªç‹¼': 'å¥½è‰²å¤šæƒ…ï¼Œæ˜“æœ‰å©šå¤–æƒ…ï¼Œéœ€è¦è‡ªå¾‹ã€‚',
            'å·¨é–€': 'äº¤æµå……åˆ†ï¼Œå¤«å¦»å¤šè«‡è«–ï¼Œæ˜“æœ‰ç£¨æ“¦ã€‚',
            'å¤©ç›¸': 'æ„Ÿæƒ…è€å¯¦ï¼Œå©šå§»ç©©å®šï¼Œç‚ºäººé«”è²¼ã€‚',
            'ç ´è»': 'å©šå§»æ˜“æœ‰æ³¢æŠ˜ï¼Œéœ€è¦ç›¸äº’åŒ…å®¹ã€‚',
            'ä¸ƒæ®º': 'æ„Ÿæƒ…å†·æ¼ ï¼Œä½†ä¸€æ—¦æ±ºå®šå‰‡å …æŒåˆ°åº•ã€‚',
        }
        
        analysis += love_map_male.get(fu_mao_star, 'æ„Ÿæƒ…éœ€è¦èªçœŸç¶“ç‡Ÿã€‚')
        
        return analysis

    def _generate_overall_analysis(self, main_stars: Dict, personality: str, fortune: str) -> str:
        """ç”Ÿæˆæ•´é«”åˆ†æ"""
        analysis = "ã€æ•´é«”å‘½ç›¤åˆ†æã€‘\n"
        analysis += "="*50 + "\n"
        
        ming_gong_star = main_stars.get('å‘½å®®', {}).get('star', 'ç´«å¾®')
        
        if 'ç´«å¾®' in ming_gong_star or 'å¤©åºœ' in ming_gong_star:
            analysis += "æ‚¨æ˜¯å‘½æ ¼è¼ƒç‚ºå‰åˆ©çš„äººï¼Œå…·æœ‰é ˜å°åŠ›å’Œç®¡ç†èƒ½åŠ›ã€‚\n"
            analysis += "å»ºè­°å……åˆ†ç™¼æ®è‡ªå·±çš„å„ªå‹¢ï¼Œç©æ¥µé€²å–ã€‚\n"
        elif 'å¤©æ©Ÿ' in ming_gong_star or 'å¤©æ¢' in ming_gong_star:
            analysis += "æ‚¨æ˜¯è°æ…§æ™ºæ…§å‹çš„äººï¼Œé©åˆå¾äº‹éœ€è¦è…¦åŠ›çš„å·¥ä½œã€‚\n"
            analysis += "å»ºè­°æ·±åŒ–è‡ªå·±çš„å°ˆæ¥­çŸ¥è­˜å’ŒæŠ€èƒ½ã€‚\n"
        else:
            analysis += "æ‚¨çš„å‘½æ ¼éœ€è¦é€šéå¾Œå¤©åŠªåŠ›ä¾†æ”¹è®Šã€‚\n"
            analysis += "å»ºè­°ç©æ¥µå­¸ç¿’ï¼Œæå‡è‡ªå·±çš„èƒ½åŠ›ã€‚\n"
        
        analysis += "\næ­¤å‘½ç›¤åˆ†æç‚ºç°¡åŒ–ç‰ˆæœ¬ï¼Œåƒ…ä¾›åƒè€ƒã€‚\n"
        analysis += "å¯¦éš›å‘½ç†åˆ†æéœ€è¦è€ƒæ…®æ›´å¤šè¤‡é›œå› ç´ ã€‚"
        
        return analysis

    def format_result(self, result: Dict) -> str:
        """æ ¼å¼åŒ–çµæœç‚ºå­—ç¬¦ä¸²"""
        if not result.get('success', False):
            return f"âŒ è«–å‘½å¤±æ•—: {result.get('error', 'æœªçŸ¥éŒ¯èª¤')}"
        
        output = ""
        output += f"ğŸŸ£ ç´«å¾®è«–å‘½åˆ†æ\n"
        output += f"{"="*50}\n\n"
        output += f"ğŸ“… å‡ºç”Ÿæ™‚é–“: {result['date']}\n"
        output += f"ğŸ‘¥ æ€§åˆ¥: {result['gender']}\n"
        output += f"ğŸ‰ ç”Ÿè‚–: {result['zodiac']}\n"
        output += f"âœ¨ ç´éŸ³äº”è¡Œ: {result['nayin']}\n\n"
        
        output += f"ã€å‘½å®®ã€‘\n"
        output += f"å®®ä½: {result['ming_gong']['palace']} ({result['ming_gong']['branch']})\n\n"
        
        output += result['palace_analysis'] + "\n\n"
        output += result['personality'] + "\n\n"
        output += result['fortune'] + "\n\n"
        output += result['career'] + "\n\n"
        output += result['love'] + "\n\n"
        output += result['overall']
        
        return output


# å¿«é€ŸæŸ¥è©¢ç‰ˆæœ¬
class SimplePurpleStarCalculator:
    """ç°¡åŒ–ç‰ˆç´«å¾®è¨ˆç®—å™¨"""
    
    BRANCHES = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥']
    ZODIACS = ['é¼ ', 'ç‰›', 'è™', 'å…”', 'é¾', 'è›‡', 'é¦¬', 'ç¾Š', 'çŒ´', 'é›', 'ç‹—', 'è±¬']
    
    @staticmethod
    def quick_analysis(year: int, month: int, day: int, hour: int = 12, gender: str = 'M') -> str:
        """å¿«é€Ÿåˆ†æ"""
        year_index = (year - 1900) % 12
        month_index = (month - 1) % 12
        hour_index = (hour // 2) % 12
        
        ming_index = (month_index + hour_index) % 12
        branch = SimplePurpleStarCalculator.BRANCHES[ming_index]
        zodiac = SimplePurpleStarCalculator.ZODIACS[year_index]
        
        output = f"ã€ç´«å¾®è«–å‘½å¿«é€ŸæŸ¥è©¢ã€‘\n"
        output += f"{"="*40}\n"
        output += f"å‡ºç”Ÿæ™‚é–“: {year}å¹´{month}æœˆ{day}æ—¥ {hour}æ™‚ ({gender})\n"
        output += f"ç”Ÿè‚–: {zodiac}\n"
        output += f"å‘½å®®åœ°æ”¯: {branch}\n\n"
        output += f"åŸºæœ¬åˆ†æ:\n"
        output += f"  æ‚¨çš„å‘½å®®åœ¨ {branch} ä½ï¼Œçµåˆç”Ÿè‚– {zodiac}ï¼Œ\n"
        output += f"  æ•´é«”å‘½æ ¼è¶¨æ–¼å¹³è¡¡ç™¼å±•ã€‚\n\n"
        output += f"å»ºè­°: ç©©å¥ç™¼å±•ï¼Œä¸å®œéåº¦å†’éšªã€‚\n"
        
        return output
