#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
周易卜卦系統
"""

import random
from datetime import datetime

class YijingAnalyzer:
    def __init__(self):
        self.hexagrams = {
            1: ("乾", "乾為天", "元亨利貞", "剛健中正，自強不息"),
            2: ("坤", "坤為地", "元亨利牝馬之貞", "柔順厚德，包容萬物"),
            3: ("屯", "水雷屯", "元亨利貞勿用有攸往利建侯", "萬事開頭難，需要耐心"),
            4: ("蒙", "山水蒙", "亨匪我求童蒙童蒙求我", "啟蒙教育，由不明到明"),
            5: ("需", "水天需", "有孚光亨貞吉利涉大川", "等待時機，需要耐心"),
            6: ("訟", "天水訟", "有孚窒惕中吉終凶", "爭訟之象，宜和不宜爭"),
            7: ("師", "地水師", "貞丈人吉無咎", "統御之道，以正治軍"),
            8: ("比", "水地比", "吉原筮元永貞無咎", "親近和睦，團結一致"),
            9: ("小畜", "風天小畜", "亨密雲不雨自我西郊", "小有積蓄，尚未豐滿"),
            10: ("履", "天澤履", "履虎尾不咥人亨", "小心謹慎，如履薄冰"),
            11: ("泰", "地天泰", "小往大來吉亨", "通泰順利，陰陽調和"),
            12: ("否", "天地否", "否之匪人不利君子貞大往小來", "閉塞不通，需要等待"),
            13: ("同人", "天火同人", "同人于野亨利涉大川", "志同道合，團結協作"),
            14: ("大有", "火天大有", "元亨", "大有收獲，興盛繁榮"),
            15: ("謙", "地山謙", "亨君子有終", "謙虛謹慎，受益無窮"),
            16: ("豫", "雷地豫", "利建侯行師", "和樂愉悅，順勢而為"),
            17: ("隨", "澤雷隨", "元亨利貞無咎", "隨時而動，隨機應變"),
            18: ("蠱", "山風蠱", "元亨利涉大川", "整治腐敗，改革更新"),
            19: ("臨", "地澤臨", "元亨利貞至于八月有凶", "臨事處理，恩威並施"),
            20: ("觀", "風地觀", "盥而不薦有孚顒若", "觀察學習，省察自身"),
            21: ("噬嗑", "火雷噬嗑", "亨利用獄", "咬合之象，施行刑罰"),
            22: ("賁", "山火賁", "亨小利有攸往", "文飾華美，內外兼修"),
            23: ("剝", "山地剝", "不利有攸往", "剝落之象，守正待時"),
            24: ("復", "地雷復", "亨出入無疾朋來無咎", "復返歸來，萬物更新"),
            25: ("無妄", "天雷無妄", "元亨利貞其匪正有眚不利有攸往", "純真自然，不妄作為"),
            26: ("大畜", "山天大畜", "利貞不家食吉利涉大川", "大有積蓄，剛健篤實"),
            27: ("頤", "山雷頤", "貞吉觀頤自求口實", "頤養之道，慎言節食"),
            28: ("大過", "澤風大過", "棟撓利有攸往亨", "過度之象，承受壓力"),
            29: ("坎", "坎為水", "有孚維心亨行有尚", "陷入險境，需要智慧"),
            30: ("離", "離為火", "利貞亨畜牝牛吉", "光明附麗，文明之象"),
            31: ("咸", "澤山咸", "亨利貞取女吉", "感應交流，男女相感"),
            32: ("恆", "雷風恆", "亨無咎利貞利有攸往", "恆久不變，持之以恆"),
            33: ("遯", "天山遯", "亨小利貞", "退隱遠離，避世保身"),
            34: ("大壯", "雷天大壯", "利貞", "陽剛強盛，剛健有力"),
            35: ("晉", "火地晉", "康侯用錫馬蕃庶晝日三接", "晉升進步，光明上進"),
            36: ("明夷", "地火明夷", "利艱貞", "光明受傷，韜光養晦"),
            37: ("家人", "風火家人", "利女貞", "家庭和睦，各守本分"),
            38: ("睽", "火澤睽", "小事吉", "分離乖違，求同存異"),
            39: ("蹇", "水山蹇", "利西南不利東北利見大人貞吉", "艱難險阻，需要幫助"),
            40: ("解", "雷水解", "利西南無所往其來復吉", "解除困難，舒緩放鬆"),
            41: ("損", "山澤損", "有孚元吉無咎可貞利有攸往", "減損有益，損己利人"),
            42: ("益", "風雷益", "利有攸往利涉大川", "增益得利，有利發展"),
            43: ("夬", "澤天夬", "揚于王庭孚號有厲告自邑", "決斷果決，當機立斷"),
            44: ("姤", "天風姤", "女壯勿用取女", "不期而遇，慎防陰柔"),
            45: ("萃", "澤地萃", "亨王假有廟利見大人亨利貞", "聚集匯合，團結合作"),
            46: ("升", "地風升", "元亨用見大人勿恤南征吉", "上升提高，順勢而上"),
            47: ("困", "澤水困", "亨貞大人吉無咎有言不信", "困境艱難，守正待變"),
            48: ("井", "水風井", "改邑不改井無喪無得", "供養不竭，德澤廣被"),
            49: ("革", "澤火革", "己日乃孚元亨利貞悔亡", "革新變革，除舊布新"),
            50: ("鼎", "火風鼎", "元吉亨", "鼎新革故，穩固基業"),
            51: ("震", "震為雷", "亨震來虩虩笑言啞啞", "震動驚恐，警惕謹慎"),
            52: ("艮", "艮為山", "艮其背不獲其身", "止住靜守，適可而止"),
            53: ("漸", "風山漸", "女歸吉利貞", "循序漸進，穩步前行"),
            54: ("歸妹", "雷澤歸妹", "征凶無攸利", "少女出嫁，婚姻之象"),
            55: ("豐", "雷火豐", "亨王假之勿憂宜日中", "豐盛繁榮，盛極而衰"),
            56: ("旅", "火山旅", "小亨旅貞吉", "旅行在外，謹慎小心"),
            57: ("巽", "巽為風", "小亨利有攸往利見大人", "謙遜順從，柔順深入"),
            58: ("兌", "兌為澤", "亨利貞", "喜悅和樂，開朗愉快"),
            59: ("渙", "風水渙", "亨王假有廟利涉大川利貞", "渙散離析，聚散離合"),
            60: ("節", "水澤節", "亨苦節不可貞", "節制有度，守正中庸"),
            61: ("中孚", "風澤中孚", "豚魚吉利涉大川利貞", "誠信感人，內心誠實"),
            62: ("小過", "雷山小過", "亨利貞可小事不可大事", "小有過越，謹守本分"),
            63: ("既濟", "水火既濟", "亨小利貞初吉終亂", "已經完成，盛極而衰"),
            64: ("未濟", "火水未濟", "亨小狐汔濟濡其尾無攸利", "尚未完成，謹慎行事")
        }
        
    def divine(self, birth_date, question="人生運勢"):
        """
        根據出生日期進行卜卦
        """
        # 使用出生日期和當前時間作為種子
        seed = int(birth_date.replace("-", "")) + int(datetime.now().strftime("%H%M%S"))
        random.seed(seed)
        
        # 生成本卦和變卦
        main_hexagram = random.randint(1, 64)
        changing_line = random.randint(1, 6)
        
        result = f"""
╔══════════════════════════════════════════════════════════════╗
║                    ☯ 周易卜卦分析 ☯                          ║
╚══════════════════════════════════════════════════════════════╝

📅 出生日期：{birth_date}
🔮 占卜問題：{question}
⏰卜卦時間：{datetime.now().strftime('%Y-%m-%d %H:%M')}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【本卦】第{main_hexagram}卦

{self._draw_hexagram(main_hexagram)}

卦名：{self.hexagrams[main_hexagram][0]}（{self.hexagrams[main_hexagram][1]}）
卦辭：{self.hexagrams[main_hexagram][2]}
卦義：{self.hexagrams[main_hexagram][3]}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【爻位】

本卦第 {changing_line} 爻動

{self._get_line_interpretation(main_hexagram, changing_line)}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【卦象解析】

{self._interpret_hexagram(main_hexagram)}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【運勢指引】

{self._get_fortune_guide(main_hexagram)}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【行動建議】

{self._get_action_advice(main_hexagram, changing_line)}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
"""
        return result
    
    def _draw_hexagram(self, num):
        """繪製卦象"""
        # 簡化版本的六爻繪製
        hexagram_patterns = {
            1: ["▬▬▬▬▬", "▬▬▬▬▬", "▬▬▬▬▬", "▬▬▬▬▬", "▬▬▬▬▬", "▬▬▬▬▬"],  # 乾
            2: ["▬▬ ▬▬", "▬▬ ▬▬", "▬▬ ▬▬", "▬▬ ▬▬", "▬▬ ▬▬", "▬▬ ▬▬"],  # 坤
            11: ["▬▬ ▬▬", "▬▬ ▬▬", "▬▬ ▬▬", "▬▬▬▬▬", "▬▬▬▬▬", "▬▬▬▬▬"],  # 泰
            12: ["▬▬▬▬▬", "▬▬▬▬▬", "▬▬▬▬▬", "▬▬ ▬▬", "▬▬ ▬▬", "▬▬ ▬▬"],  # 否
            63: ["▬▬ ▬▬", "▬▬▬▬▬", "▬▬ ▬▬", "▬▬▬▬▬", "▬▬ ▬▬", "▬▬▬▬▬"],  # 既濟
            64: ["▬▬▬▬▬", "▬▬ ▬▬", "▬▬▬▬▬", "▬▬ ▬▬", "▬▬▬▬▬", "▬▬ ▬▬"],  # 未濟
        }
        
        # 如果有預定義的卦象就使用，否則隨機生成
        if num in hexagram_patterns:
            lines = hexagram_patterns[num]
        else:
            # 根據卦號生成陰陽爻
            random.seed(num)
            lines = [random.choice(["▬▬▬▬▬", "▬▬ ▬▬"]) for _ in range(6)]
        
        result = "      上卦\n"
        for i, line in enumerate(reversed(lines), 1):
            result += f"    {line}   {7-i}爻\n"
        result += "      下卦\n"
        return result
    
    def _get_line_interpretation(self, hexagram, line):
        """解釋爻位"""
        interpretations = {
            1: "初爻：處於開始階段，基礎尚未穩固，宜謹慎行事",
            2: "二爻：處於內部中位，得中之道，進退適宜",
            3: "三爻：處於內卦之終，是轉折關鍵，需要變通",
            4: "四爻：處於外卦之始，開始對外發展，謹慎為上",
            5: "五爻：處於外卦中位，最尊貴的位置，大有可為",
            6: "上爻：處於最高位，事物發展到極致，物極必反"
        }
        return interpretations.get(line, "此爻變化需要深思")
    
    def _interpret_hexagram(self, num):
        """解釋卦象"""
        special_interpretations = {
            1: "乾卦象徵天，代表剛健、進取、創造。此時正是積極行動、自強不息的時候。",
            2: "坤卦象徵地，代表順從、包容、厚德。宜以柔順之道處事，厚德載物。",
            11: "泰卦天地交泰，表示通達順利。內陽外陰，正是和諧發展的好時機。",
            12: "否卦天地不交，表示閉塞不通。此時宜守不宜進，等待時機。",
            63: "既濟卦表示事情已經完成，但需注意盛極而衰，居安思危。",
            64: "未濟卦表示事情尚未完成，但蘊含新的開始和希望。"
        }
        
        if num in special_interpretations:
            return special_interpretations[num]
        else:
            name, full_name, _, meaning = self.hexagrams[num]
            return f"{name}卦（{full_name}）表示：{meaning}\n此卦象指引你在當前處境中應該如何應對。"
    
    def _get_fortune_guide(self, num):
        """運勢指引"""
        fortune_guides = {
            1: "◆ 事業：積極進取，把握機會，大展宏圖\n◆ 財運：財源廣進，投資有利\n◆ 感情：主動出擊，真誠相待\n◆ 健康：精力充沛，注意勞逸結合",
            2: "◆ 事業：順勢而為，厚積薄發，穩紮穩打\n◆ 財運：財運平穩，細水長流\n◆ 感情：溫柔體貼，包容理解\n◆ 健康：調養身體，注重休息",
            11: "◆ 事業：通達順利，合作愉快，大有發展\n◆ 財運：財運亨通，收入豐厚\n◆ 感情：和諧美滿，感情升溫\n◆ 健康：身心健康，狀態良好",
            12: "◆ 事業：遇到阻礙，宜守不宜進\n◆ 財運：財運不佳，節制開支\n◆ 感情：溝通不暢，需要耐心\n◆ 健康：注意調理，預防疾病",
            63: "◆ 事業：事業有成，但需居安思危\n◆ 財運：財運良好，但勿貪心\n◆ 感情：關係穩定，需要維護\n◆ 健康：身體健康，保持現狀",
            64: "◆ 事業：雖未完成，但前景可期\n◆ 財運：財運待發，需要耐心\n◆ 感情：感情發展中，慢慢培養\n◆ 健康：調養得當，逐步改善"
        }
        
        default_guide = "◆ 事業：穩步前進，審時度勢\n◆ 財運：理性投資，量入為出\n◆ 感情：真誠相待，互相理解\n◆ 健康：注意保健，勞逸結合"
        
        return fortune_guides.get(num, default_guide)
    
    def _get_action_advice(self, hexagram, line):
        """行動建議"""
        advice = []
        
        if hexagram in [1, 11, 14, 34]:
            advice.append("宜：積極行動，把握機會，勇往直前")
            advice.append("忌：猶豫不決，錯失良機")
        elif hexagram in [2, 12, 23, 52]:
            advice.append("宜：靜待時機，韜光養晦，修身養性")
            advice.append("忌：急於求成，冒險行事")
        else:
            advice.append("宜：審時度勢，靈活應變，中庸之道")
            advice.append("忌：固執己見，剛愎自用")
        
        if line in [1, 2]:
            advice.append("當前處於初期階段，宜謹慎布局，打好基礎")
        elif line in [3, 4]:
            advice.append("當前處於發展階段，宜積極進取，但要注意分寸")
        else:
            advice.append("當前處於高位，宜深謀遠慮，居安思危")
        
        return "\n".join([f"• {a}" for a in advice])


if __name__ == "__main__":
    analyzer = YijingAnalyzer()
    result = analyzer.divine("1990-05-15", "事業發展")
    print(result)
